<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaTeX æ™ºèƒ½æ¸²æŸ“å™¨ (æœ€ç»ˆç‰ˆ)</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #f0f0f0; /* å…¨å±€æ–‡å­—é¢œè‰²ï¼Œç¡®ä¿åœ¨æ·±è‰²èƒŒæ™¯ä¸Šå¯è§ */
            background-color: #007bff; /* å¤‡ç”¨èƒŒæ™¯è‰² */
            background-image: linear-gradient(to bottom right, #007bff, #20c997);
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- å¡ç‰‡åŸºç¡€æ ·å¼ --- */
        .card-base {
            background: rgba(255, 255, 255, 0.20); /* æ¯›ç»ç’ƒæ•ˆæœ */
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px; /* è®¾å®šæœ€å¤§å®½åº¦ */
            position: relative;
            overflow: hidden;
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
            gap: 20px; /* å†…éƒ¨å…ƒç´ é—´è· */
        }
        
        /* --- æ ‡é¢˜å’Œæ–‡æœ¬æ ·å¼ --- */
        h1 {
            text-align: center;
            margin: 0 0 10px 0;
            font-size: 2.2em;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
        }
        p {
            text-align: center;
            margin: 0;
            font-size: 1.1em;
            color: #e0e0e0;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.4);
        }

        /* --- æ–‡æœ¬è¾“å…¥åŒºæ ·å¼ --- */
        textarea {
            width: 100%;
            height: 120px;
            padding: 15px;
            font-family: "Courier New", Courier, monospace;
            font-size: 1.2rem;
            color: #fff;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            box-sizing: border-box;
            resize: vertical; /* å…è®¸ç”¨æˆ·å‚ç›´è°ƒæ•´å¤§å° */
            transition: all 0.3s ease;
        }
        textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        textarea:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.7);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        /* --- æŒ‰é’®åŒºåŸŸå’Œé€šç”¨æŒ‰é’®æ ·å¼ --- */
        .button-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .button-base {
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .button-base:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .button-base:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* ç‰¹å®šæŒ‰é’®é¢œè‰² */
        .gemini-button {
            background: linear-gradient(to right, #8965e0 0%, #5e72e4 51%, #8965e0 100%);
            background-size: 200% auto;
            transition: all .5s ease-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .gemini-button:hover {
            background-position: right center;
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        /* --- æ–°å¢ï¼šDeepSeek Test æŒ‰é’®æ ·å¼ --- */
        .deepseek-button {
            background: linear-gradient(to right, #11cdef 0%, #1171ef 51%, #11cdef 100%);
            background-size: 200% auto;
            transition: all .5s ease-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .deepseek-button:hover {
            background-position: right center;
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .render-button-png { background-color: rgba(80, 150, 220, 0.5); }
        .render-button-screenshot { background-color: rgba(40, 167, 69, 0.5); }
        .render-button-screenshot:disabled {
            background: rgba(150, 150, 150, 0.5);
            cursor: wait;
            transform: none;
        }

        /* --- SVG é¢„è§ˆåŒºæ ·å¼ --- */
        .preview-container {
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: 15px;
            padding-top: 25px;
            display: none; 
            text-align: center;
        }
        .preview-container h3 {
            margin: 0 0 15px 0;
            font-size: 1.5em;
            font-weight: bold;
            color: #f0f0f0;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.7);
        }
        
        /* â˜…â˜…â˜… è¿™é‡Œæ˜¯ä¸»è¦ä¿®æ”¹ç‚¹ â˜…â˜…â˜… */
        .preview-box {
            width: 100%;
            min-height: 100px;
            /* 1. å°†èƒŒæ™¯æ”¹ä¸ºç™½è‰² */
            background: #ffffff;
            /* 2. è¾¹æ¡†æ”¹ä¸ºæµ…ç°è‰²å®çº¿ï¼Œæ›´é€‚åˆç™½è‰²èƒŒæ™¯ */
            border: 1px solid #ddd;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 25px;
            box-sizing: border-box;
            overflow: auto;
            /* 3. æ·»åŠ å†…é˜´å½±å¢åŠ è´¨æ„Ÿ */
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
        }
        #svgPreviewImage {
            max-width: 100%;
            height: auto;
        }

        /* --- å¼¹çª—æ ·å¼ (Modal) --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s, opacity 0.3s;
        }
        .modal.show {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background: rgba(50, 50, 50, 0.5);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            padding: 30px 40px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            color: #f0f0f0;
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 15px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.8em;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.7);
        }
        .close-button {
            font-size: 2em;
            font-weight: bold;
            color: #f0f0f0;
            cursor: pointer;
            background: none;
            border: none;
            opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s;
        }
        .close-button:hover {
            opacity: 1;
            transform: rotate(90deg);
        }
        .modal-body {
            font-size: 1.1em;
            line-height: 1.7;
            white-space: pre-wrap; /* ä¿æŒæ¢è¡Œå’Œç©ºæ ¼ */
        }
    </style>
</head>
<body>

    <div class="card-base">
        <h1>LaTeXæ¸²æŸ“å™¨</h1>
        <p>ä¸€ä¸ªä¸AIé›†æˆçš„æ¸²æŸ“LaTexæ ¼å¼çš„ç½‘ç«™</p>
        
        <textarea id="latexInput" placeholder="å¯ä»¥åœ¨è¿™é‡Œè¾“å…¥ä½ çš„é—®é¢˜ï¼Œç„¶åç‚¹å‡»æŒ‰é’®Deepseekè§£é‡Šå…¬å¼è·å¾—ä½ çš„ç­”æ¡ˆï¼"></textarea>
        
        <div class="button-container">
            <button id="geminiExplainButton" class="button-base gemini-button"> âœ¨ </button>
            
            <button id="deepseekTestButton" class="button-base deepseek-button">Deepseekè§£é‡Šé—®é¢˜</button>

            <a id="pngLinkButton" href="#" class="button-base render-button-png" target="_blank" rel="noopener noreferrer">æ‰“å¼€PNGå¹¶ä¿å­˜</a>
            <button id="screenshotButton" class="button-base render-button-screenshot">ä¸‹è½½é¢„è§ˆæˆªå›¾</button>
        </div>

        <div class="preview-container" id="previewContainer">
            <h3>å®æ—¶çŸ¢é‡å›¾ (SVG) é¢„è§ˆ</h3>
            <div class="preview-box" id="previewBox">
                <img id="svgPreviewImage" src="" alt="LaTeX é¢„è§ˆ">
            </div>
        </div>
    </div>

    <div class="modal" id="explanationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">âœ¨ å…¬å¼è§£é‡Š</h2>
                <button class="close-button" id="closeModalButton">&times;</button>
            </div>
            <div class="modal-body" id="explanationOutput">
                æ­£åœ¨æ€è€ƒä¸­...
            </div>
        </div>
    </div>

    <script>
        // --- è·å–æ‰€æœ‰éœ€è¦çš„ HTML å…ƒç´  ---
        const latexInputBox = document.getElementById('latexInput');
        const pngLinkButton = document.getElementById('pngLinkButton');
        const previewContainer = document.getElementById('previewContainer');
        const svgPreviewImage = document.getElementById('svgPreviewImage');
        const previewBox = document.getElementById('previewBox');
        const screenshotButton = document.getElementById('screenshotButton');
        const geminiExplainButton = document.getElementById('geminiExplainButton');
        const deepseekTestButton = document.getElementById('deepseekTestButton'); // æ–°å¢
        const explanationModal = document.getElementById('explanationModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const explanationOutput = document.getElementById('explanationOutput');
        const modalTitle = document.getElementById('modalTitle'); // æ–°å¢

        // --- å¸¸é‡å®šä¹‰ ---
        // â˜…â˜…â˜… è¿™é‡Œæ˜¯å¦ä¸€ä¸ªä¿®æ”¹ç‚¹ â˜…â˜…â˜…
        // ç§»é™¤äº† \bg{white}ï¼Œå¢åŠ äº† \color{black} æ¥ç¡®ä¿åœ¨ç™½è‰²èƒŒæ™¯ä¸Šæ˜¾ç¤ºé»‘è‰²å­—ä½“
        const staticPrefix = "\\inline&space;\\huge&space;\\dpi{110}\\color{black}"; 
        const pngBaseURL = "https://latex.codecogs.com/png.image?";
        const svgBaseURL = "https://latex.codecogs.com/svg.image?";
        
        // --- Gemini API é…ç½® ---
        const geminiApiKey = ""; 
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

        // --- æ–°å¢: DeepSeek API é…ç½® ---
        // !!! é‡è¦: è¯·åœ¨æ­¤å¤„ç²˜è´´æ‚¨çš„ DeepSeek API å¯†é’¥ !!!
        const deepseekApiKey = "sk-b85b5fba97af4c96a80108954b894c4e"; 
        const deepseekApiUrl = "https://api.deepseek.com/chat/completions";

        // --- Gemini API è°ƒç”¨å‡½æ•° (ä¸å˜) ---
        async function callGemini(systemInstruction, userPrompt) {
            try {
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                };
                const response = await fetch(geminiApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}.`);
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œæ— æ³•è·å–è§£é‡Šã€‚";
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return `å‡ºé”™äº†: ${error.message}`;
            }
        }
        
        // --- æ–°å¢: DeepSeek API è°ƒç”¨å‡½æ•° ---
        async function callDeepSeek(systemInstruction, userPrompt) {
            if (deepseekApiKey === "åœ¨æ­¤å¤„ç²˜è´´æ‚¨çš„ DeepSeek API å¯†é’¥" || !deepseekApiKey) {
                return "é”™è¯¯ï¼šè¯·åœ¨ JavaScript ä»£ç ä¸­å¡«å…¥æ‚¨çš„ DeepSeek API å¯†é’¥ã€‚";
            }
            try {
                const payload = {
                    model: "deepseek-chat", // DeepSeek èŠå¤©æ¨¡å‹
                    messages: [
                        { role: "system", content: systemInstruction },
                        { role: "user", content: userPrompt }
                    ]
                };
                const response = await fetch(deepseekApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${deepseekApiKey}` // ä½¿ç”¨ Bearer Token è®¤è¯
                    },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API request failed with status ${response.status}. Details: ${JSON.stringify(errorBody)}`);
                }
                const result = await response.json();
                return result.choices?.[0]?.message?.content || "æŠ±æ­‰ï¼Œæ— æ³•è·å–è§£é‡Šã€‚";
            } catch (error) {
                console.error("DeepSeek API call failed:", error);
                return `å‡ºé”™äº†: ${error.message}`;
            }
        }


        // --- æ›´æ–°é¢„è§ˆå’Œé“¾æ¥çš„å‡½æ•° (ä¸å˜) ---
        function updateOutputs() {
            const userInput = latexInputBox.value.trim();
            if (userInput === "") {
                previewContainer.style.display = "none";
                svgPreviewImage.src = "";
                return;
            }
            previewContainer.style.display = "block";
            const encodedInput = encodeURIComponent(userInput);
            pngLinkButton.href = pngBaseURL + staticPrefix + encodedInput;
            svgPreviewImage.src = svgBaseURL + staticPrefix + encodedInput;
        }

        // --- Gemini åŠŸèƒ½é€»è¾‘ (ä¸å˜) ---
        geminiExplainButton.addEventListener('click', async () => {
            const latexCode = latexInputBox.value.trim();
            if (!latexCode) {
                alert("è¾“å…¥æ¡†ä¸­æ²¡æœ‰å…¬å¼å¯ä»¥è§£é‡Šã€‚");
                return;
            }
            modalTitle.textContent = "âœ¨ Gemini å…¬å¼è§£é‡Š";
            explanationOutput.textContent = "æ­£åœ¨è°ƒç”¨ Gemini...";
            explanationModal.classList.add('show');
            const systemInstruction = "You are a friendly and helpful math and science tutor. Explain the following mathematical formula, which is written in LaTeX, in simple and easy-to-understand Chinese. Explain what the overall formula means and what each variable or symbol represents.";
            const explanation = await callGemini(systemInstruction, latexCode);
            explanationOutput.textContent = explanation;
        });
        
        // --- æ–°å¢: DeepSeek åŠŸèƒ½é€»è¾‘ ---
        deepseekTestButton.addEventListener('click', async () => {
            const latexCode = latexInputBox.value.trim();
            if (!latexCode) {
                alert("è¾“å…¥æ¡†ä¸­æ²¡æœ‰å…¬å¼å¯ä»¥æµ‹è¯•ã€‚");
                return;
            }
            modalTitle.textContent = "ğŸ§ªDeepSeek æ¨¡å‹æµ‹è¯•";
            explanationOutput.textContent = "æ­£åœ¨è°ƒç”¨ DeepSeek...ï¼ˆé¢„è®¡çº¦5ç§’å·¦å³ï¼‰";
            explanationModal.classList.add('show');
const systemInstruction = "You are an intelligent AI assistant, users will ask you questions, and you need to answer them kindly. When users send you LaTeX text, you need to explain the meaning of this text and the underlying formula (if the LaTeX text is a formula that you know; if not, kindly explain the meaning of the expression they provided). Communicate entirely in Simplified Chinese..";           const explanation = await callDeepSeek(systemInstruction, latexCode);
            explanationOutput.textContent = explanation;
        });


        // --- å¼¹çª—æ§åˆ¶ (ä¸å˜) ---
        closeModalButton.addEventListener('click', () => explanationModal.classList.remove('show'));
        explanationModal.addEventListener('click', (event) => {
            if (event.target === explanationModal) {
                explanationModal.classList.remove('show');
            }
        });

        // --- å±å¹•æ•æ‰è„šæœ¬ (ä¸å˜) ---
        screenshotButton.addEventListener('click', captureAndDownloadPreview);

        async function captureAndDownloadPreview() {
            if (previewContainer.style.display === 'none' || latexInputBox.value.trim() === '') {
                alert("é¢„è§ˆåŒºæ˜¯ç©ºçš„ï¼Œæ— æ³•æˆªå›¾ã€‚");
                return;
            }
            screenshotButton.disabled = true;
            screenshotButton.textContent = "è¯·æˆæƒ...";
            let stream = null, canvas = document.createElement('canvas'), video = document.createElement('video');
            try {
                stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: "browser" },
                    audio: false,
                    preferCurrentTab: true
                });
                const track = stream.getVideoTracks()[0];
                video.srcObject = stream;
                await new Promise(resolve => video.onloadedmetadata = resolve);
                video.play();
                await new Promise(resolve => setTimeout(resolve, 100));
                const rect = previewBox.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 
                    rect.left * dpr, rect.top * dpr, rect.width * dpr, rect.height * dpr,
                    0, 0, canvas.width, canvas.height
                );
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = 'latex-preview.png';
                a.click();
            } catch (err) {
                console.error("æˆªå›¾å¤±è´¥:", err);
                if (err.name !== 'NotAllowedError') {
                      alert("æˆªå›¾å¤±è´¥ï¼Œè¯·ç¡®ä¿æ‚¨åœ¨æœ¬åœ°HTMLæ–‡ä»¶ä¸­è¿è¡Œã€‚");
                }
            } finally {
                if (stream) stream.getTracks().forEach(t => t.stop());
                canvas.remove();
                video.remove();
                screenshotButton.disabled = false;
                screenshotButton.textContent = "ä¸‹è½½é¢„è§ˆæˆªå›¾";
            }
        }
        
        // --- åˆå§‹äº‹ä»¶ç»‘å®šå’Œè¿è¡Œ ---
        latexInputBox.addEventListener('input', updateOutputs);
        updateOutputs();
    </script>

</body>
</html>
